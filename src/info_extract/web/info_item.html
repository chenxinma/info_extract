<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel标准化配置管理 | 智能映射版</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <!-- 引入SweetAlert2组件 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/sweetalert2/11.23.0/sweetalert2.min.css" rel="stylesheet">
    <!-- 引入Select2组件 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <!-- 引入Sortable.js库 -->
    <script src="/static/Sortable.min.js"></script>
    <!-- 引入统一样式文件 -->
    <link href="/static/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <!-- 主内容区 -->
    <main class="overflow-hidden">
        <!-- 配置管理 -->
        <div id="view-config" class="overflow-y-auto p-6 max-w-7xl mx-auto w-full">
            <!-- 配置管理面板 -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">定义标准输出字段 (Schema)</h2>
                    <div class="space-x-2">
                        <button type="button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200" id="btn-refresh">
                            <i class="fa-solid fa-sync-alt mr-2"></i> 刷新
                        </button>
                        <button type="button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200" id="btn-add">
                            <i class="fa-solid fa-plus mr-2"></i> 添加字段
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="config-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 80px;">排序</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">字段名称</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述 (Prompt Hint)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 120px;">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="config-table-body">
                            <!-- 动态生成行 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Excel 配置 -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4"><i class="fa-solid fa-table text-green-600 mr-2"></i>Excel 映射增强</h2>
                    <p class="text-sm text-gray-500 mb-4">配置可能的表头同义词，帮助模型识别列。</p>
                    
                    <div class="space-y-4">
                        
                    </div>
                </div>

                <!-- 文本标注配置 -->
                <div class="bg-white shadow rounded-lg p-6">
                    <a href="/config/mark_extracts" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" >
                        <i class="fa-solid fa-file-lines text-blue-600 mr-2"></i>文本标注配置 (Few-Shot)
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- 引入JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/sweetalert2/11.23.0/sweetalert2.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        // Config data will be loaded from the backend
        let configData = [];
        let currentEditId = null;
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-right',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });


        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigData();
            bindEvents();
        });


        // Load data from the backend
        async function loadConfigData() {
            try {
                const response = await fetch('/config/info_item');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                configData = await response.json();
                renderConfigTable();
            } catch (error) {
                console.error('Error loading config data:', error);
                Toast.fire({
                    icon: 'error',
                    title: '加载配置数据失败'
                });
            }
        }

        // Render the configuration table
        function renderConfigTable() {
            const tableBody = document.getElementById('config-table-body');
            const filteredData = configData;

            // Sort data by sort_no before rendering
            filteredData.sort((a, b) => a.sort_no - b.sort_no);

            // Render rows
            if (filteredData.length === 0) {
                tableBody.innerHTML = '';
                return;
            }

            function quote(str) {
                if (!str) {
                    return '';
                }
                return str.replace(/"/g, '&quot;');
            }

            tableBody.innerHTML = filteredData.map(item => `
                <tr data-id="${item.id}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" value="${item.sort_no}" class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 block border p-1" data-field="sort_no" data-id="${item.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" value="${item.label}" class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full border p-1" data-field="label" data-id="${item.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full border p-1" data-field="data_type" data-id="${item.id}">
                            <option value="str" ${item.data_type === 'str' ? 'selected' : ''}>文本</option>
                            <option value="numeric" ${item.data_type === 'numeric' ? 'selected' : ''}>数字</option>
                            <option value="date" ${item.data_type === 'date' ? 'selected' : ''}>日期</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="text" value="${quote(item.describe)}" class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full border p-1" data-field="describe" data-id="${item.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 delete-btn" data-id="${item.id}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Add event listeners for inline edit
            document.querySelectorAll('#config-table input, #config-table select').forEach(element => {
                element.addEventListener('change', function() {
                    const id = parseInt(this.dataset.id);
                    const field = this.dataset.field;
                    const value = this.type === 'checkbox' ? this.checked : this.value;

                    updateConfigField(id, field, value);
                });
            });
        }


        // Get badge color based on data type
        function getTypeBadgeColor(type) {
            switch(type) {
                case 'str': return 'blue';
                case 'numeric': return 'green';
                case 'date': return 'yellow';
                case 'boolean': return 'purple';
                default: return 'gray';
            }
        }

        // Update a specific field of a config item
        async function updateConfigField(id, field, value) {
            try {
                // Find the config item in the local data
                const configItem = configData.find(item => item.id === id);
                if (!configItem) {
                    throw new Error(`Config item with id ${id} not found`);
                }

                // Update the field in the local data
                configItem[field] = value;

                // Update the item on the server
                const response = await fetch(`/config/info_item/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configItem)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                Toast.fire({
                    icon: 'success',
                    title: '配置项已更新'
                });
            } catch (error) {
                console.error('Error updating config field:', error);
                Toast.fire({
                    icon: 'error',
                    title: '更新配置项失败'
                });

                // Reload the config data to revert the change in UI
                loadConfigData();
            }
        }

        // Add a new configuration item
        async function addNewConfigItem() {
            try {
                // Create a default new config item
                const newConfig = {
                    label: '新字段',
                    data_type: 'str',
                    describe: '字段描述',
                    sort_no: configData.length + 1
                };

                // Send the new config item to the server
                const response = await fetch('/config/info_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newConfig)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Add the new item to the local data
                const savedConfig = await response.json();
                configData.push(savedConfig);

                // Re-render the table
                renderConfigTable();

                Toast.fire({
                    icon: 'success',
                    title: '配置项已添加'
                });
            } catch (error) {
                console.error('Error adding new config item:', error);
                Toast.fire({
                    icon: 'error',
                    title: '添加配置项失败'
                });
            }
        }

        // Bind events
        function bindEvents() {
            // Add button
            document.getElementById('btn-add').addEventListener('click', function() {
                addNewConfigItem();
            });

            // Refresh button
            document.getElementById('btn-refresh').addEventListener('click', function() {
                loadConfigData();
            });

            // Delete button event
            document.addEventListener('click', async function(e) {
                if (e.target.closest('.delete-btn')) {
                    const id = parseInt(e.target.closest('.delete-btn').dataset.id);
                    const config = configData.find(item => item.id === id);

                    const result = await Swal.fire({
                        title: '确认删除？',
                        text: '是否删除配置项【' + config.label + '】？此操作不可恢复',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: '删除',
                        cancelButtonText: '取消',
                        confirmButtonColor: '#F53F3F',
                        cancelButtonColor: '#6B7280'
                    });

                    if (result.isConfirmed) {
                        try {
                            const response = await fetch('/config/info_item/' + id, {
                                method: 'DELETE'
                            });

                            if (!response.ok) {
                                throw new Error('HTTP error! status: ' + response.status);
                            }

                            configData = configData.filter(item => item.id !== id);
                            renderConfigTable();
                            Toast.fire({
                                icon: 'success',
                                title: '配置项已删除'
                            });
                        } catch (error) {
                            console.error('Error deleting config:', error);
                            Toast.fire({
                                icon: 'error',
                                title: '删除配置项失败'
                            });
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>