<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel标准化配置管理 | 智能映射版</title>
    <!-- 引入Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入图标库 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 引入Toast组件 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- 引入自动完成插件 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #165DFF;
            --primary-light: #E8F3FF;
            --secondary-color: #6B7280;
            --success-color: #00B42A;
            --danger-color: #F53F3F;
            --warning-color: #FF7D00;
            --light-bg: #F9FAFB;
            --border-color: #E5E7EB;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.06);
            --hover-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --transition: all 0.2s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            background-color: var(--light-bg);
            color: #333;
            line-height: 1.5;
        }

        /* 顶部导航栏优化 */
        .header-bar {
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0.8rem 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            border-radius: 6px;
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #0E4BD8;
            border-color: #0E4BD8;
            box-shadow: 0 2px 4px rgba(22, 93, 255, 0.2);
        }

        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-light);
        }

        /* 主容器优化 */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 1.2rem;
            padding: 1.2rem;
            min-height: calc(100vh - 70px);
        }

        /* 列表区域优化 */
        .list-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .list-section:hover {
            box-shadow: var(--hover-shadow);
        }

        .list-header {
            padding: 1rem 1.2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--light-bg);
        }

        .list-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .list-title {
            font-weight: 600;
            font-size: 1rem;
            margin: 0;
        }

        .search-box {
            position: relative;
            width: 280px;
        }

        .search-input {
            padding-left: 2rem !important;
            font-size: 0.85rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            height: 2.2rem;
        }

        .search-icon {
            position: absolute;
            left: 0.7rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        /* 表格优化 */
        .table-container {
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }

        .config-table {
            margin: 0;
            font-size: 0.85rem;
        }

        .config-table thead th {
            padding: 0.8rem 1rem;
            vertical-align: middle;
            font-weight: 600;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--border-color);
            background-color: var(--light-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .config-table tbody td {
            padding: 0.8rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .config-table tbody tr {
            cursor: pointer;
            transition: var(--transition);
        }

        .config-table tbody tr:hover {
            background-color: var(--primary-light);
        }

        .config-table tbody tr.active {
            background-color: rgba(22, 93, 255, 0.1);
            border-left: 3px solid var(--primary-color);
        }

        /* 行内操作按钮优化 */
        .action-buttons {
            display: flex;
            gap: 0.3rem;
        }

        .action-btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .edit-btn {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .edit-btn:hover {
            background-color: var(--primary-light);
        }

        .delete-btn {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .delete-btn:hover {
            background-color: #FEF0F0;
        }

        /* 排序手柄优化 */
        .sort-handle {
            cursor: grab;
            color: var(--secondary-color);
            padding: 0.2rem;
            border-radius: 2px;
            transition: var(--transition);
        }

        .sort-handle:hover {
            color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .sort-handle:active {
            cursor: grabbing;
        }

        /* 编辑区域优化 */
        .edit-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(100vh - 70px);
            transition: var(--transition);
        }

        .edit-section:hover {
            box-shadow: var(--hover-shadow);
        }

        .edit-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.4rem;
            color: #444;
        }

        .form-control, .form-select {
            font-size: 0.85rem;
            padding: 0.5rem 0.7rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
            outline: none;
        }

        .form-text {
            font-size: 0.75rem;
            color: var(--secondary-color);
            margin-top: 0.3rem;
        }

        /* 表单操作区 */
        .form-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.5rem;
        }

        .form-actions .btn {
            flex: 1;
            padding: 0.6rem;
            font-weight: 500;
        }

        /* SQL预览优化 */
        .preview-card {
            margin-top: 1.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.2rem;
            background-color: var(--light-bg);
            transition: var(--transition);
        }

        .preview-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .preview-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
        }

        .preview-content {
            font-size: 0.8rem;
            line-height: 1.6;
            background-color: white;
            padding: 0.8rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-family: "Consolas", "Monaco", monospace;
        }

        /* 空状态样式 */
        .empty-state {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--secondary-color);
        }

        .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #CED4DA;
        }

        .empty-text {
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        /* Toast提示位置 */
        .swal2-container {
            z-index: 9999 !important;
        }

        /* 响应式优化 */
        @media (max-width: 992px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 0.8rem;
            }

            .edit-section {
                max-height: none;
                margin-top: 1rem;
            }

            .search-box {
                width: 100%;
                max-width: 280px;
            }

            .table-container {
                max-height: 400px;
            }
        }

        @media (max-width: 576px) {
            .header-actions {
                flex-wrap: wrap;
            }

            .list-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
            }

            .list-header-left {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
            }

            .search-box {
                width: 100%;
                max-width: none;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部操作栏 -->
    <div class="header-bar">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div class="header-title">
                    <i class="bi bi-table"></i>
                    <span>Excel标准化配置管理</span>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-import">
                        <i class="bi bi-upload me-1"></i>导入配置
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-export">
                        <i class="bi bi-download me-1"></i>导出配置
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="btn-batch">
                        <i class="bi bi-list-check me-1"></i>批量操作
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="btn-preview-sql">
                        <i class="bi bi-code me-1"></i>预览SQL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="container-fluid main-container">
        <!-- 配置列表区 -->
        <div class="list-section">
            <div class="list-header">
                <div class="list-header-left">
                    <h5 class="list-title">配置项列表</h5>
                    <div class="search-box">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="form-control search-input" id="search-input" placeholder="搜索标准表头/说明/数据类型">
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-sm" id="btn-add">
                    <i class="bi bi-plus-circle me-1"></i>新增配置项
                </button>
            </div>
            <div class="table-container">
                <table class="table config-table mb-0" id="config-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><i class="bi bi-grip-vertical sort-handle"></i></th>
                            <th style="width: 60px;">ID</th>
                            <th>标准表头</th>
                            <th>数据类型</th>
                            <th>说明/同义词</th>
                            <th style="width: 80px;">排序号</th>
                            <th style="width: 120px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="config-table-body">
                        <!-- 配置项数据行 -->
                    </tbody>
                </table>
                <!-- 空状态 -->
                <div class="empty-state d-none" id="empty-state">
                    <div class="empty-icon">
                        <i class="bi bi-table"></i>
                    </div>
                    <div class="empty-text">暂无配置项，点击"新增配置项"开始创建</div>
                    <button type="button" class="btn btn-primary btn-sm" id="empty-add-btn">
                        <i class="bi bi-plus me-1"></i>新增配置项
                    </button>
                </div>
            </div>
        </div>

        <!-- 详情编辑区 -->
        <div class="edit-section">
            <h5 class="edit-title" id="edit-title">新增配置项</h5>
            <form id="config-form">
                <input type="hidden" id="config-id">

                <div class="form-group">
                    <label for="label" class="form-label">标准表头 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="label" placeholder="例如：客户姓名、订单金额" required>
                    <div class="form-text">最终输出的标准化表头名称（唯一）</div>
                </div>

                <div class="form-group">
                    <label for="describe" class="form-label">说明/同义词</label>
                    <textarea class="form-control" id="describe" rows="3" placeholder="例如：手机号、电话、联系方式（多个同义词用逗号分隔）"></textarea>
                    <div class="form-text">帮助AI识别不同表述的表头，提升映射准确率</div>
                </div>

                <div class="form-group">
                    <label for="data_type" class="form-label">数据类型 <span class="text-danger">*</span></label>
                    <select class="form-select" id="data_type" required>
                        <option value="">请选择数据类型</option>
                        <option value="str">文本</option>
                        <option value="numeric">数字</option>
                        <option value="date">日期</option>
                        <option value="boolean">布尔</option>
                    </select>
                    <div class="form-text">用于AI识别字段类型，确保数据格式统一</div>
                </div>

                <div class="form-group">
                    <label for="sort_no" class="form-label">排序号</label>
                    <input type="number" class="form-control" id="sort_no" placeholder="数字越小越靠前" min="0">
                    <div class="form-text">为空则按添加顺序排列，支持拖拽调整</div>
                </div>

                <div class="form-group">
                    <label for="sample_col_name" class="form-label">样本字段名</label>
                    <input type="text" class="form-control" id="sample_col_name" placeholder="例如：姓名、手机号">
                    <div class="form-text">用于生成AI提示词的样本Excel字段名</div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="btn-save">
                        <i class="bi bi-save me-1"></i>保存配置
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="btn-reset">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>重置
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="btn-clear" style="display: none;">
                        <i class="bi bi-trash me-1"></i>清空
                    </button>
                </div>
            </form>

            <!-- SQL预览区域 -->
            <div class="preview-card d-none" id="sql-preview">
                <div class="preview-title">
                    <i class="bi bi-code-slash"></i>
                    样本SQL预览
                </div>
                <pre class="preview-content" id="preview-content"></pre>
            </div>

            <!-- 提示词预览区域 -->
            <div class="preview-card d-none" id="prompt-preview">
                <div class="preview-title">
                    <i class="bi bi-chat-dots"></i>
                    AI提示词预览
                </div>
                <pre class="preview-content" id="prompt-content"></pre>
            </div>
        </div>
    </div>

    <!-- 引入JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Config data will be loaded from the backend
        let configData = [];
        let currentEditId = null;
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-right',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initSelect2();
            loadConfigData();
            bindEvents();
        });

        // Initialize select2 plugin
        function initSelect2() {
            $('#data_type').select2({
                placeholder: "请选择数据类型",
                minimumResultsForSearch: Infinity,
                width: '100%'
            });
        }

        // Load data from the backend
        async function loadConfigData() {
            try {
                const response = await fetch('/config/info_item');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                configData = await response.json();
                renderConfigTable();
                checkEmptyState();
            } catch (error) {
                console.error('Error loading config data:', error);
                Toast.fire({
                    icon: 'error',
                    title: '加载配置数据失败'
                });
            }
        }

        // Render the configuration table
        function renderConfigTable() {
            const tableBody = document.getElementById('config-table-body');
            const searchValue = document.getElementById('search-input').value.toLowerCase();

            // Filter and sort
            const filteredData = configData
                .filter(item =>
                    item.label.toLowerCase().includes(searchValue) ||
                    (item.describe && item.describe.toLowerCase().includes(searchValue)) ||
                    (item.data_type && item.data_type.toLowerCase().includes(searchValue))
                )
                .sort((a, b) => (a.sort_no || 999) - (b.sort_no || 999));

            // Render rows
            if (filteredData.length === 0) {
                tableBody.innerHTML = '';
                checkEmptyState();
                return;
            }

            tableBody.innerHTML = filteredData.map(item => `
                <tr data-id="${item.id}" class="${currentEditId === item.id ? 'active' : ''}">
                    <td><i class="bi bi-grip-vertical sort-handle"></i></td>
                    <td>${item.id}</td>
                    <td>
                        <div class="fw-medium">${item.label}</div>
                    </td>
                    <td>
                        <span class="badge bg-${getTypeBadgeColor(item.data_type)} text-white px-2 py-1">
                            ${item.data_type || '未知'}
                        </span>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${item.describe || '无'}">
                            ${item.describe || '-'}
                        </div>
                    </td>
                    <td>${item.sort_no || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-sm btn-outline-primary action-btn edit-btn" data-id="${item.id}">
                                <i class="bi bi-pencil"></i> 编辑
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger action-btn delete-btn" data-id="${item.id}">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            checkEmptyState();
        }

        // Get badge color based on data type
        function getTypeBadgeColor(type) {
            switch(type) {
                case '文本': return 'primary';
                case '数字': return 'success';
                case '日期': return 'warning';
                case '布尔': return 'info';
                default: return 'secondary';
            }
        }

        // Check empty state
        function checkEmptyState() {
            const emptyState = document.getElementById('empty-state');
            const tableBody = document.getElementById('config-table-body');

            if (configData.length === 0) {
                emptyState.classList.remove('d-none');
                tableBody.classList.add('d-none');
            } else {
                emptyState.classList.add('d-none');
                tableBody.classList.remove('d-none');
            }
        }

        // Initialize drag-and-drop sorting
        function initSortable() {
            const tableBody = document.getElementById('config-table-body');
            const sortable = new Sortable(tableBody, {
                handle: '.sort-handle',
                animation: 150,
                ghostClass: 'bg-primary-light',
                chosenClass: 'bg-primary-light',
                dragClass: 'bg-primary-light',
                onStart: function(evt) {
                    // Visual feedback on drag start
                    evt.item.style.opacity = '0.8';
                    evt.item.style.transform = 'scale(1.02)';
                },
                onEnd: async function(evt) {
                    // Reset styles after drag
                    evt.item.style.opacity = '1';
                    evt.item.style.transform = 'scale(1)';

                    // Update sort order in the backend
                    const newOrder = Array.from(tableBody.children).map((row, index) => {
                        const id = parseInt(row.dataset.id);
                        return { id, sort_no: index + 1 };
                    });

                    try {
                        const response = await fetch('/config/info_item/sort', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ items: newOrder })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Update local data with new sort numbers
                        configData.forEach(item => {
                            const updatedItem = newOrder.find(i => i.id === item.id);
                            if (updatedItem) {
                                item.sort_no = updatedItem.sort_no;
                            }
                        });

                        Toast.fire({
                            icon: 'success',
                            title: '排序已更新'
                        });
                    } catch (error) {
                        console.error('Error updating sort order:', error);
                        Toast.fire({
                            icon: 'error',
                            title: '更新排序失败'
                        });
                    }
                }
            });
        }

        // Bind events
        function bindEvents() {
            // Search box with debounce
            let searchTimer;
            document.getElementById('search-input').addEventListener('input', function() {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => {
                    renderConfigTable();
                }, 300);
            });

            // Add button
            document.getElementById('btn-add').addEventListener('click', function() {
                resetForm();
                document.getElementById('edit-title').textContent = '新增配置项';
                document.getElementById('btn-clear').style.display = 'inline-block';
                document.querySelector('.edit-section').scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('empty-add-btn').addEventListener('click', function() {
                document.getElementById('btn-add').click();
            });

            // Form submission
            document.getElementById('config-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveConfig();
            });

            // Reset button
            document.getElementById('btn-reset').addEventListener('click', function() {
                if (currentEditId) {
                    loadConfigToForm(currentEditId);
                    Toast.fire({
                        icon: 'info',
                        title: '表单已重置为当前配置'
                    });
                } else {
                    resetForm();
                }
            });

            // Clear button
            document.getElementById('btn-clear').addEventListener('click', function() {
                resetForm();
                Toast.fire({
                    icon: 'info',
                    title: '表单已清空'
                });
            });

            // Row click event
            document.getElementById('config-table-body').addEventListener('click', function(e) {
                const tr = e.target.closest('tr');
                if (tr && !e.target.closest('.action-btn')) {
                    const id = parseInt(tr.dataset.id);
                    loadConfigToForm(id);
                }
            });

            // Edit button event
            document.addEventListener('click', function(e) {
                if (e.target.closest('.edit-btn')) {
                    const id = parseInt(e.target.closest('.edit-btn').dataset.id);
                    loadConfigToForm(id);
                }
            });

            // Delete button event
            document.addEventListener('click', async function(e) {
                if (e.target.closest('.delete-btn')) {
                    const id = parseInt(e.target.closest('.delete-btn').dataset.id);
                    const config = configData.find(item => item.id === id);

                    const result = await Swal.fire({
                        title: '确认删除？',
                        text: `是否删除配置项【${config.label}】？此操作不可恢复`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: '删除',
                        cancelButtonText: '取消',
                        confirmButtonColor: '#F53F3F',
                        cancelButtonColor: '#6B7280'
                    });

                    if (result.isConfirmed) {
                        try {
                            const response = await fetch(`/config/info_item/${id}`, {
                                method: 'DELETE'
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            configData = configData.filter(item => item.id !== id);
                            if (currentEditId === id) {
                                resetForm();
                            }
                            renderConfigTable();
                            Toast.fire({
                                icon: 'success',
                                title: '配置项已删除'
                            });
                        } catch (error) {
                            console.error('Error deleting config:', error);
                            Toast.fire({
                                icon: 'error',
                                title: '删除配置项失败'
                            });
                        }
                    }
                }
            });

            // Preview SQL button
            document.getElementById('btn-preview-sql').addEventListener('click', function() {
                if (configData.length === 0) {
                    Toast.fire({
                        icon: 'warning',
                        title: '暂无配置项，请先添加'
                    });
                    return;
                }

                generateSampleSQL();
                generateAIPrompt();
                document.getElementById('sql-preview').classList.remove('d-none');
                document.getElementById('prompt-preview').classList.remove('d-none');
                document.getElementById('sql-preview').scrollIntoView({ behavior: 'smooth' });
            });

            // Import button
            document.getElementById('btn-import').addEventListener('click', function() {
                // Create file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        try {
                            // Process JSON import
                            const importedData = JSON.parse(event.target.result);
                            if (Array.isArray(importedData)) {
                                // Validate data structure
                                const validData = importedData.filter(item =>
                                    item.label && typeof item.label === 'string'
                                );

                                // Check for duplicates
                                const existingLabels = configData.map(item => item.label);
                                const newData = validData.filter(item =>
                                    !existingLabels.includes(item.label)
                                );

                                try {
                                    const promises = newData.map(item => {
                                        return fetch('/config/info_item', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify(item)
                                        });
                                    });

                                    const responses = await Promise.all(promises);
                                    const allSuccessful = responses.every(response => response.ok);
                                    
                                    if (allSuccessful) {
                                        await loadConfigData(); // Reload data from the backend
                                        Toast.fire({
                                            icon: 'success',
                                            title: `成功导入 ${newData.length} 个配置项`
                                        });
                                    } else {
                                        throw new Error('部分配置项导入失败');
                                    }
                                } catch (error) {
                                    console.error('Import error:', error);
                                    throw error;
                                }
                            } else {
                                throw new Error('导入数据格式错误，应为数组');
                            }
                        } catch (error) {
                            Swal.fire({
                                icon: 'error',
                                title: '导入失败',
                                text: error.message
                            });
                        }
                    };
                    reader.readAsText(file);
                };
                fileInput.click();
            });

            // Export button
            document.getElementById('btn-export').addEventListener('click', function() {
                if (configData.length === 0) {
                    Toast.fire({
                        icon: 'warning',
                        title: '暂无配置项可导出'
                    });
                    return;
                }

                const jsonStr = JSON.stringify(configData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.download = `Excel标准化配置_${timestamp}.json`;
                a.click();
                URL.revokeObjectURL(a.href);

                Toast.fire({
                    icon: 'success',
                    title: '配置已导出'
                });
            });

            // Batch operations button
            document.getElementById('btn-batch').addEventListener('click', function() {
                if (configData.length === 0) {
                    Toast.fire({
                        icon: 'warning',
                        title: '暂无配置项可操作'
                    });
                    return;
                }

                Swal.fire({
                    title: '批量操作',
                    html: `
                        <div class="d-flex flex-column gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="batch-reset-sort">
                                <i class="bi bi-arrow-down-up"></i> 重置排序号
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="batch-clear-empty">
                                <i class="bi bi-trash"></i> 清空空值字段
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="batch-export-sql">
                                <i class="bi bi-file-code"></i> 导出SQL文件
                            </button>
                        </div>
                    `,
                    showConfirmButton: false,
                    showCancelButton: true,
                    cancelButtonText: '关闭'
                });

                // Reset sort numbers
                document.getElementById('batch-reset-sort').addEventListener('click', async function() {
                    try {
                        // Update sort_no in backend
                        const updatePromises = configData.map((item, index) => {
                            return fetch(`/config/info_item/${item.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    ...item,
                                    sort_no: index + 1
                                })
                            });
                        });

                        const responses = await Promise.all(updatePromises);
                        const allSuccessful = responses.every(response => response.ok);

                        if (allSuccessful) {
                            await loadConfigData(); // Reload data from backend
                            Swal.close();
                            Toast.fire({
                                icon: 'success',
                                title: '排序号已重置'
                            });
                        } else {
                            throw new Error('重置排序号失败');
                        }
                    } catch (error) {
                        console.error('Error resetting sort order:', error);
                        Swal.fire({
                            icon: 'error',
                            title: '重置排序号失败',
                            text: error.message
                        });
                    }
                });

                // Clear empty fields
                document.getElementById('batch-clear-empty').addEventListener('click', async function() {
                    try {
                        const updatePromises = configData.map(item => {
                            return fetch(`/config/info_item/${item.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    ...item,
                                    describe: item.describe || '',
                                    sample_col_name: item.sample_col_name || ''
                                })
                            });
                        });

                        const responses = await Promise.all(updatePromises);
                        const allSuccessful = responses.every(response => response.ok);

                        if (allSuccessful) {
                            await loadConfigData(); // Reload data from backend
                            Swal.close();
                            Toast.fire({
                                icon: 'success',
                                title: '空值字段已清空'
                            });
                        } else {
                            throw new Error('清空空值字段失败');
                        }
                    } catch (error) {
                        console.error('Error clearing empty fields:', error);
                        Swal.fire({
                            icon: 'error',
                            title: '清空空值字段失败',
                            text: error.message
                        });
                    }
                });

                // Export SQL file
                document.getElementById('batch-export-sql').addEventListener('click', function() {
                    generateSampleSQL();
                    const sqlContent = document.getElementById('preview-content').textContent;
                    const blob = new Blob([sqlContent], { type: 'text/plain;charset=utf-8' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    a.download = `Excel映射SQL_${timestamp}.sql`;
                    a.click();
                    URL.revokeObjectURL(a.href);

                    Swal.close();
                    Toast.fire({
                        icon: 'success',
                        title: 'SQL文件已导出'
                    });
                });
            });
        }

        // Reset the form
        function resetForm() {
            currentEditId = null;
            document.getElementById('edit-title').textContent = '新增配置项';
            document.getElementById('config-form').reset();
            document.getElementById('config-id').value = '';
            $('#data_type').val('').trigger('change'); // Reset select2
            document.querySelectorAll('#config-table-body tr').forEach(tr => tr.classList.remove('active'));
            document.getElementById('btn-clear').style.display = 'none';
            // Hide preview areas
            document.getElementById('sql-preview').classList.add('d-none');
            document.getElementById('prompt-preview').classList.add('d-none');
        }

        // Load configuration to form
        function loadConfigToForm(id) {
            const config = configData.find(item => item.id === id);
            if (!config) return;

            currentEditId = id;
            document.getElementById('edit-title').textContent = `编辑配置项：${config.label}`;
            document.getElementById('config-id').value = config.id;
            document.getElementById('label').value = config.label;
            document.getElementById('describe').value = config.describe || '';
            $('#data_type').val(config.data_type).trigger('change'); // Set select2 value
            document.getElementById('sort_no').value = config.sort_no || '';
            document.getElementById('sample_col_name').value = config.sample_col_name || '';
            document.getElementById('btn-clear').style.display = 'inline-block';

            // Highlight selected row
            document.querySelectorAll('#config-table-body tr').forEach(tr => {
                tr.classList.toggle('active', parseInt(tr.dataset.id) === id);
            });

            // Scroll to edit area
            document.querySelector('.edit-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Save configuration
        async function saveConfig() {
            const id = document.getElementById('config-id').value;
            const label = document.getElementById('label').value.trim();
            const describe = document.getElementById('describe').value.trim();
            const data_type = document.getElementById('data_type').value;
            const sort_no = document.getElementById('sort_no').value ? parseInt(document.getElementById('sort_no').value) : null;
            const sample_col_name = document.getElementById('sample_col_name').value.trim();

            // Validate required fields
            if (!label) {
                Toast.fire({
                    icon: 'error',
                    title: '标准表头不能为空'
                });
                document.getElementById('label').focus();
                return;
            }

            if (!data_type) {
                Toast.fire({
                    icon: 'error',
                    title: '数据类型不能为空'
                });
                $('#data_type').focus();
                return;
            }

            try {
                const config = {
                    label,
                    describe,
                    data_type,
                    sort_no,
                    sample_col_name
                };

                let response;
                if (id) {
                    // Update existing configuration
                    response = await fetch(`/config/info_item/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const updatedItem = await response.json();
                    
                    // Update local data
                    const index = configData.findIndex(item => item.id === parseInt(id));
                    if (index !== -1) {
                        configData[index] = updatedItem;
                    }
                    
                    Toast.fire({
                        icon: 'success',
                        title: '配置已更新'
                    });
                } else {
                    // Create new configuration
                    response = await fetch('/config/info_item', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(config)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const newItem = await response.json();
                    configData.push(newItem);
                    currentEditId = newItem.id;
                    
                    Toast.fire({
                        icon: 'success',
                        title: '配置已添加'
                    });
                }

                renderConfigTable();
                loadConfigToForm(currentEditId);
            } catch (error) {
                console.error('Error saving config:', error);
                Toast.fire({
                    icon: 'error',
                    title: '保存配置失败'
                });
            }
        }

        // Generate sample SQL
        function generateSampleSQL() {
            // Sort by sort_no
            const sortedConfig = [...configData].sort((a, b) => (a.sort_no || 999) - (b.sort_no || 999));

            // Build field mapping
            const fieldMap = sortedConfig.map(item => {
                const sampleCol = item.sample_col_name || item.label;
                return `    ${sampleCol} AS "${item.label}"`;
            }).join(',\n');

            // Build sample SQL
            const sampleSQL = `-- Excel标准化映射样本SQL
-- 生成时间：${new Date().toLocaleString()}
-- 字段说明：自动适配不同表头表述，统一输出标准化字段
SELECT
${fieldMap}
FROM 原始Excel数据;

-- 字段类型说明：
${sortedConfig.map(e => `-- ${e.label}：${e.data_type}（${e.describe || '无'}）`).join('\n')}

-- 使用说明：
-- 1. 将"原始Excel数据"替换为实际数据表/视图名
-- 2. 可根据实际需求添加WHERE条件、排序等
-- 3. 该SQL仅为参考，实际映射由AI生成`;

            document.getElementById('preview-content').textContent = sampleSQL;
        }

        // Generate AI prompt
        function generateAIPrompt() {
            const sortedConfig = [...configData].sort((a, b) => (a.sort_no || 999) - (b.sort_no || 999));

            // Build field mapping description
            const fieldDesc = sortedConfig.map(item => {
                return `- 标准表头：${item.label}
  数据类型：${item.data_type}
  同义词/别名：${item.describe || '无'}
  样本字段名：${item.sample_col_name || item.label}`;
            }).join('\n\n');

            const prompt = `### 任务描述
请分析Excel表格的表头，将不同表述的字段映射为标准化表头，并生成SQL语句实现字段转换。

### 标准化字段配置
${fieldDesc}

### 要求
1. 识别Excel中与标准化字段匹配的表头（包括同义词、别名）
2. 生成SQL语句，将识别到的字段映射为对应的标准化表头
3. 确保字段数据类型正确（文本/数字/日期/布尔）
4. 按配置的排序号输出标准化表头
5. 处理空值、异常值，保证数据完整性
6. SQL语句需兼容主流数据库（MySQL/PostgreSQL/Oracle）

### 输入示例
Excel表头：姓名,手机号,金额,下单日期

### 输出示例
SELECT
    姓名 AS "客户姓名",
    手机号 AS "联系电话",
    金额 AS "订单金额",
    下单日期 AS "下单时间"
FROM 原始Excel数据;

### 请根据以上配置，生成适配任意Excel表头的通用SQL映射语句`;

            document.getElementById('prompt-content').textContent = prompt;
        }
    </script>
</body>
</html>