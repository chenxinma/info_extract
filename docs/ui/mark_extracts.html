<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>划词信息项标记</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入统一样式文件 -->
    <link href="static/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-medium text-gray-900">文本划词信息项标记</h2>
            </div>

            <div class="mb-4 text-sm text-gray-600 space-y-2">
                <p>1. 在编辑区域粘贴/输入文本</p>
                <p>2. 选中任意文字，点击上方信息项按钮完成标定</p>
                <p>3. 信息项数据会实时显示在下方区域，支持重置和导出</p>
                <p>4. 可以在示例文本管理区查看、编辑已有样本或新增样本</p>
            </div>
        </div>

        <!-- Example Management Section -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">示例文本</h3>

            <!-- Example Text List -->
            <div class="mb-4">
                <div id="example-list" class="max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2">
                    <!-- Example items will be added here dynamically -->
                </div>
            </div>

            <div class="flex space-x-3">
                <button id="add-new-example-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                    <i class="fa-solid fa-plus mr-2"></i> 添加新示例
                </button>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="info-item-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="customer_name" id="btn-customer_name" disabled>客户名称</button>
                <button class="info-item-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="contact_info" id="btn-contact_info" disabled>联系方式</button>
                <button class="info-item-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="contract_id" id="btn-contract_id" disabled>合同编号</button>
                <button class="info-item-btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="contract_amount" id="btn-contract_amount" disabled>合同金额</button>
                <button class="info-item-btn bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="other" id="btn-other" disabled>其他信息</button>
            </div>

            <div>
                <h3 class="text-sm font-medium text-gray-700 mb-2">文本编辑区</h3>
                <div id="text-area" contenteditable="true" class="w-full min-h-[300px] p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base leading-loose bg-white whitespace-pre-wrap"></div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">标注结果详情</label>
                <table class="min-w-full divide-y divide-gray-200" id="extraction-table">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">文本</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">信息项</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">属性</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="extraction-tbody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">新增属性</label>
                <div class="flex space-x-2">
                    <input type="text" id="attr-key" placeholder="属性名" class="flex-1 p-2 border border-gray-300 rounded-md">
                    <input type="text" id="attr-value" placeholder="属性值" class="flex-1 p-2 border border-gray-300 rounded-md">
                    <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none" id="add-attr-btn">
                        <i class="fa-solid fa-plus mr-2"></i> 添加属性
                    </button>
                </div>
            </div>

            <div class="flex space-x-3">
                <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none" id="save-extraction-btn">
                    <i class="fa-solid fa-save mr-2"></i> 保存
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== 元素获取 ==========
        const textArea = document.getElementById('text-area');
        const infoItemBtns = document.querySelectorAll('.info-item-btn');
        const btnCustomerName = document.getElementById('btn-customer_name');
        const btnContactInfo = document.getElementById('btn-contact_info');
        const btnContractId = document.getElementById('btn-contract_id');
        const btnContractAmount = document.getElementById('btn-contract_amount');
        const btnOther = document.getElementById('btn-other');

        // Example management elements
        const exampleList = document.getElementById('example-list');
        const addNewExampleBtn = document.getElementById('add-new-example-btn');

        // Extraction management elements
        const extractionTable = document.getElementById('extraction-table');
        const extractionTbody = document.getElementById('extraction-tbody');
        const attrKeyInput = document.getElementById('attr-key');
        const attrValueInput = document.getElementById('attr-value');
        const addAttrBtn = document.getElementById('add-attr-btn');
        const saveExtractionBtn = document.getElementById('save-extraction-btn');

        // ========== 全局变量 ==========
        let selectedRange = null;
        let selectedText = '';
        let infoItemRecord = [];
        // 存储信息项标记的映射：{ 占位符: { text: 文字, type: 信息项 } }
        let placeholderMap = new Map();
        let examples = []; // 存储所有示例文本
        let currentExampleId = null; // 当前正在编辑的示例ID
        let extractions = []; // 存储当前示例的所有提取结果
        let selectedExtraction = null; // 当前选中的提取结果

        // ========== 示例文本管理 ==========
        function loadExamples() {
            // 模拟从数据库加载示例文本
            // 实际应用中这里应该调用API获取数据
            examples = [
                {id: 1, fragment: "这是一段测试的示例文本，客户名称是张三，联系方式是13888888888"},
                {id: 2, fragment: "合同编号为CT-2023-001，合同金额为50000元整"},
                {id: 3, fragment: "其他信息可能包括地址、日期等具体内容"}
            ];

            updateExampleList();
        }

        function updateExampleList() {
            // 清空列表
            exampleList.innerHTML = '';

            // 添加所有示例
            examples.forEach(example => {
                const div = document.createElement('div');
                div.className = 'example-item p-2 border-b border-gray-200 cursor-pointer hover:bg-gray-50 flex justify-between items-center';
                div.dataset.id = example.id;

                const text = document.createElement('span');
                text.textContent = `示例 ${example.id}: ${example.fragment.substring(0, 60)}${example.fragment.length > 60 ? '...' : ''}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-example-btn text-red-500 hover:text-red-700 text-sm';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent triggering the load example action
                    deleteExample(example.id);
                };

                div.appendChild(text);
                div.appendChild(deleteBtn);

                div.onclick = () => loadExampleById(example.id);

                exampleList.appendChild(div);
            });
        }

        function loadExampleById(id) {
            const example = examples.find(e => e.id === id);
            if (example) {
                textArea.innerHTML = example.fragment;
                currentExampleId = example.id;

                // 加载此示例对应的提取结果
                loadExtractionsForExample(example.id);

                // 显示当前示例的提取结果
                renderExtractions();
            }
        }

        function saveExample() {
            const textContent = textArea.innerHTML || textArea.innerText;
            if (!textContent.trim()) {
                alert('请先输入示例文本');
                return;
            }

            if (currentExampleId) {
                // 更新现有示例
                const index = examples.findIndex(e => e.id === currentExampleId);
                if (index !== -1) {
                    examples[index].fragment = textContent;
                }
            } else {
                // 创建新示例
                const newId = examples.length > 0 ? Math.max(...examples.map(e => e.id)) + 1 : 1;
                examples.push({
                    id: newId,
                    fragment: textContent
                });
                currentExampleId = newId;
            }

            updateExampleList();
            alert('示例文本已保存');
        }

        function addNewExample() {
            // Clear existing content in text area
            textArea.innerHTML = '';
            currentExampleId = null;

            // Clear extraction table
            extractions = [];
            renderExtractions();

            // If no text in input, add an empty example
            const newId = examples.length > 0 ? Math.max(...examples.map(e => e.id)) + 1 : 1;
            examples.push({
                id: newId,
                fragment: ''
            });

            updateExampleList();

            // Select the newly added empty example
            setTimeout(() => {
                const newItem = document.querySelector(`.example-item[data-id="${newId}"]`);
                if(newItem) {
                    newItem.click();
                }
            }, 100);
        }

        function deleteExample(id) {
            if (confirm('确定要删除这个示例吗？')) {
                examples = examples.filter(e => e.id !== id);

                // Also delete related extractions
                extractions = extractions.filter(ex => ex.exampleId !== id);

                // If we're deleting the currently loaded example, clear the editor
                if (currentExampleId === id) {
                    textArea.innerHTML = '';
                    currentExampleId = null;
                    renderExtractions(); // Clear the extraction table
                }

                updateExampleList();
            }
        }

        // ========== 提取结果管理 ==========
        function loadExtractionsForExample(exampleId) {
            // 模拟从数据库加载对应示例的提取结果
            // 实际应用中这里应该调用API获取数据
            extractions = [
                {id: 1, exampleId: exampleId, text: "张三", infoItemType: "customer_name", attributes: [{"key": "type", "value": "primary"}]},
                {id: 2, exampleId: exampleId, text: "13888888888", infoItemType: "contact_info", attributes: []},
                {id: 3, exampleId: exampleId, text: "CT-2023-001", infoItemType: "contract_id", attributes: [{"key": "status", "value": "valid"}]}
            ].filter(ex => ex.exampleId === exampleId);
        }

        function renderExtractions() {
            extractionTbody.innerHTML = '';

            extractions.forEach(extraction => {
                const row = document.createElement('tr');

                // 创建文本单元格
                const textCell = document.createElement('td');
                textCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                textCell.textContent = extraction.text;

                // 创建信息项单元格
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';

                // 根据类型显示对应的中文名称
                let typeName = extraction.infoItemType;
                if (extraction.infoItemType === 'customer_name') typeName = '客户名称';
                else if (extraction.infoItemType === 'contact_info') typeName = '联系方式';
                else if (extraction.infoItemType === 'contract_id') typeName = '合同编号';
                else if (extraction.infoItemType === 'contract_amount') typeName = '合同金额';
                else if (extraction.infoItemType === 'other') typeName = '其他信息';

                typeCell.textContent = `${typeName} (${extraction.infoItemType})`;

                // 创建属性单元格
                const attrCell = document.createElement('td');
                attrCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';

                if (extraction.attributes && extraction.attributes.length > 0) {
                    const attrList = extraction.attributes.map(attr => `${attr.key}:${attr.value}`).join(', ');
                    attrCell.textContent = attrList;
                } else {
                    attrCell.textContent = '无';
                }

                // 创建操作单元格
                const actionCell = document.createElement('td');
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium';

                const selectBtn = document.createElement('button');
                selectBtn.className = 'text-indigo-600 hover:text-indigo-900 mr-2';
                selectBtn.innerHTML = '<i class="fas fa-edit"></i> 选择';
                selectBtn.onclick = () => selectExtraction(extraction);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-600 hover:text-red-900';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 删除';
                deleteBtn.onclick = () => deleteExtraction(extraction.id);

                actionCell.appendChild(selectBtn);
                actionCell.appendChild(deleteBtn);

                row.appendChild(textCell);
                row.appendChild(typeCell);
                row.appendChild(attrCell);
                row.appendChild(actionCell);

                extractionTbody.appendChild(row);
            });
        }

        function selectExtraction(extraction) {
            selectedExtraction = extraction;
            // 在界面上高亮显示选中的提取结果
            Array.from(extractionTbody.children).forEach((row, index) => {
                if (extractions[index].id === extraction.id) {
                    row.classList.add('bg-blue-50');
                } else {
                    row.classList.remove('bg-blue-50');
                }
            });
        }

        function deleteExtraction(extractionId) {
            extractions = extractions.filter(ex => ex.id !== extractionId);
            renderExtractions();
            if (selectedExtraction && selectedExtraction.id === extractionId) {
                selectedExtraction = null;
            }
        }

        function addAttribute() {
            if (!selectedExtraction) {
                alert('请先选择一个提取结果');
                return;
            }

            const key = attrKeyInput.value.trim();
            const value = attrValueInput.value.trim();

            if (!key || !value) {
                alert('请输入属性名和属性值');
                return;
            }

            // 检查是否已存在相同的属性键
            const existingIndex = selectedExtraction.attributes.findIndex(attr => attr.key === key);
            if (existingIndex !== -1) {
                // 更新现有属性
                selectedExtraction.attributes[existingIndex].value = value;
            } else {
                // 添加新属性
                selectedExtraction.attributes.push({key, value});
            }

            // 清空输入框
            attrKeyInput.value = '';
            attrValueInput.value = '';

            // 重新渲染表格
            renderExtractions();

            // 再次选中当前提取结果
            selectExtraction(selectedExtraction);
        }

        function saveExtractions() {
            if (!currentExampleId) {
                alert('请先加载或保存一个示例文本');
                return;
            }

            // 更新所有提取结果的exampleId，确保与当前示例匹配
            extractions.forEach(extraction => {
                extraction.exampleId = currentExampleId;
            });

            // 模拟保存到数据库
            // 实际应用中这里应该调用API保存数据
            console.log('Saving extractions:', extractions);

            // 重新渲染提取结果
            renderExtractions();
            alert('标注结果已保存');
        }

        // ========== 核心功能 (保留原有的划词交互) ==========
        textArea.addEventListener('mouseup', handleSelection);
        textArea.addEventListener('keyup', handleSelection);
        textArea.addEventListener('selectionchange', handleSelection);
        textArea.addEventListener('input', syncTextSource);

        function handleSelection() {
            const selection = window.getSelection();
            selectedText = selection.toString().trim();

            infoItemBtns.forEach(btn => {
                if (!selectedText) {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                }
            });

            selectedRange = selectedText && selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
        }

        [btnCustomerName, btnContactInfo, btnContractId, btnContractAmount, btnOther].forEach(btn => {
            btn.addEventListener('click', () => {
                if (!selectedRange || !selectedText) return;

                const type = btn.getAttribute('data-type');
                const typeName = btn.textContent;
                // 生成唯一占位符（避免与表格符号冲突）
                const placeholder = `__${type}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}__`;

                // 替换选中文本为带样式的span，并存储占位符映射
                replaceSelectedText(type, selectedText, placeholder);
                // 记录信息项数据
                addInfoItemRecord(selectedText, type, typeName);

                // 立即更新提取结果表格
                const newExtraction = {
                    id: Date.now(), // 临时ID，保存时再获取正式ID
                    exampleId: currentExampleId || 0, // 如果没有加载示例，则为0
                    text: selectedText,
                    infoItemType: type,
                    attributes: [] // 默认为空属性数组
                };

                // 检查是否已存在相同的提取
                const existingIndex = extractions.findIndex(
                    ex => ex.text === selectedText && ex.infoItemType === type
                );

                if (existingIndex !== -1) {
                    // 更新现有提取
                    extractions[existingIndex] = {
                        ...extractions[existingIndex],
                        text: selectedText,
                        infoItemType: type
                    };
                } else {
                    // 添加新的提取
                    extractions.push(newExtraction);
                }

                // 重新渲染标注结果表格
                renderExtractions();

                // 存储占位符映射
                placeholderMap.set(placeholder, { text: selectedText, type: type });

                window.getSelection().removeAllRanges();
                infoItemBtns.forEach(b => {
                    b.disabled = true;
                    b.classList.add('disabled');
                });
                syncTextSource();
            });
        });

        // ========== 测试功能 ==========
        function testIntegration() {
            // 添加示例文本
            textArea.innerHTML = "这是一段测试文本，包含客户名称张三，联系方式是13888888888，合同编号为CT-2023-001，金额为50000元。";

            alert("测试文本已添加，现在可以尝试划词标注功能。请选中部分文本并点击对应的标注按钮。");
        }

        // 页面加载完成后初始化示例
        document.addEventListener('DOMContentLoaded', function() {
            loadExamples();
        });

        // ========== 文本同步 ==========
        function syncTextSource() {
            // 获取原始HTML内容而不是纯文本，保留格式包括换行
            let htmlContent = textArea.innerHTML;

            // 遍历所有信息项span，替换为唯一占位符（避免重复文本替换错误）
            const spans = textArea.querySelectorAll('span.customer_name, span.contact_info, span.contract_id, span.contract_amount, span.other');
            spans.forEach(span => {
                const placeholder = span.getAttribute('data-placeholder');
                if (placeholder) {
                    const spanOuterHtml = span.outerHTML;
                    // 使用正则表达式安全地替换span为占位符，保留换行符和其他格式
                    htmlContent = htmlContent.replace(spanOuterHtml, placeholder);

                    // 后续再将占位符替换回span格式
                    htmlContent = htmlContent.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'),
                        spanOuterHtml);
                }
            });

            // 保持原有HTML结构
            textArea.innerHTML = htmlContent;
        }

        /**
         * 替换选中的文本为带信息项样式的span（新增唯一占位符属性）
         * @param {string} type - 信息项类型
         * @param {string} text - 选中的文本
         * @param {string} placeholder - 唯一占位符
         */
        function replaceSelectedText(type, text, placeholder) {
            const selectedNode = selectedRange.commonAncestorContainer.parentElement;
            if (selectedNode.classList.contains(type) && selectedNode.getAttribute('data-placeholder')) {
                return;
            }

            const span = document.createElement('span');
            span.className = type;
            span.classList.add('px-1', 'rounded-sm', 'mr-1');

            // Add custom styling based on type
            switch(type) {
                case 'customer_name':
                    span.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'contact_info':
                    span.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'contract_id':
                    span.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'contract_amount':
                    span.classList.add('bg-purple-100', 'text-purple-800');
                    break;
                case 'other':
                    span.classList.add('bg-indigo-100', 'text-indigo-800');
                    break;
            }

            span.textContent = text;
            span.setAttribute('data-text', text);
            span.setAttribute('data-placeholder', placeholder); // 存储唯一占位符

            selectedRange.deleteContents();
            selectedRange.insertNode(span);

            const newRange = document.createRange();
            newRange.setStartAfter(span);
            newRange.collapse(true);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(newRange);
        }

        // ========== 其他工具函数 ==========
        function addInfoItemRecord(text, type, typeName) {
            const existingIndex = infoItemRecord.findIndex(item => item.text === text);
            if (existingIndex > -1) {
                infoItemRecord[existingIndex] = { text, type, typeName };
            } else {
                infoItemRecord.push({ text, type, typeName });
            }
        }

        function removeInfoItemRecord(text) {
            const index = infoItemRecord.findIndex(item => item.text === text);
            if (index > -1) {
                infoItemRecord.splice(index, 1);
                return true;
            }
            return false;
        }

        // ========== 取消标定功能 ==========
        function unmarkText(spanElement) {
            const originalText = spanElement.getAttribute('data-text');
            const placeholder = spanElement.getAttribute('data-placeholder');

            // Remove from records
            removeInfoItemRecord(originalText);

            // Remove from placeholder map
            placeholderMap.delete(placeholder);

            // Replace span with original text
            const textNode = document.createTextNode(originalText);
            spanElement.parentNode.replaceChild(textNode, spanElement);
        }

        // Add event listener to text area for clicks on marked text
        textArea.addEventListener('click', function(event) {
            if (event.target.tagName === 'SPAN' &&
                (event.target.classList.contains('customer_name') ||
                 event.target.classList.contains('contact_info') ||
                 event.target.classList.contains('contract_id') ||
                 event.target.classList.contains('contract_amount') ||
                 event.target.classList.contains('other'))) {

                // Prevent text selection when clicking on marked text
                event.preventDefault();

                // Unmark the clicked text
                unmarkText(event.target);
            }
        });

        // ========== 事件监听 ==========
        addNewExampleBtn.addEventListener('click', addNewExample);
        addAttrBtn.addEventListener('click', addAttribute);
        saveExtractionBtn.addEventListener('click', saveExtractions);
        

        // 为可编辑区域添加初始提示
        if (textArea.innerHTML.trim() === '') {
            textArea.innerHTML = '';
        }

        // 初始化示例数据
        loadExamples();
    </script>
</body>
</html>
