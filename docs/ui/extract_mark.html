<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>划词信息项标记</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入统一样式文件 -->
    <link href="static/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-medium text-gray-900">文本划词信息项标记</h2>
            </div>

            <div class="mb-4 text-sm text-gray-600 space-y-2">
                <p>1. 在编辑区域粘贴/输入文本</p>
                <p>2. 选中任意文字，点击上方信息项按钮完成标定</p>
                <p>3. 信息项数据会实时显示在下方区域，支持重置和导出</p>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="info-item-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="customer_name" id="btn-customer_name" disabled>客户名称</button>
                <button class="info-item-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="contact_info" id="btn-contact_info" disabled>联系方式</button>
                <button class="info-item-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="contract_id" id="btn-contract_id" disabled>合同编号</button>
                <button class="info-item-btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="contract_amount" id="btn-contract_amount" disabled>合同金额</button>
                <button class="info-item-btn bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" data-type="other" id="btn-other" disabled>其他信息</button>
            </div>

            <div>
                <h3 class="text-sm font-medium text-gray-700 mb-2">文本编辑区</h3>
                <div id="text-area" contenteditable="true" class="w-full min-h-[400px] p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base leading-loose bg-white whitespace-pre-wrap"></div>
            </div>

            <div class="mt-6">
                <h3 class="text-sm font-medium text-gray-700 mb-2">信息项数据记录：</h3>
                <div id="info-item-data" class="w-full p-4 bg-gray-50 rounded-md text-sm text-gray-600 whitespace-pre-wrap min-h-[80px] border border-gray-200"></div>

                <div class="flex space-x-3 mt-4">
                    <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none" id="reset-btn">
                        <i class="fa-solid fa-sync-alt mr-2"></i> 重置所有内容
                    </button>
                    <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none" id="export-btn">
                        <i class="fa-solid fa-download mr-2"></i> 导出信息项数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== 元素获取 ==========
        const textArea = document.getElementById('text-area');
        const infoItemBtns = document.querySelectorAll('.info-item-btn');
        const infoItemData = document.getElementById('info-item-data');
        const resetBtn = document.getElementById('reset-btn');
        const exportBtn = document.getElementById('export-btn');
        const btnCustomerName = document.getElementById('btn-customer_name');
        const btnContactInfo = document.getElementById('btn-contact_info');
        const btnContractId = document.getElementById('btn-contract_id');
        const btnContractAmount = document.getElementById('btn-contract_amount');
        const btnOther = document.getElementById('btn-other');

        // ========== 全局变量 ==========
        let selectedRange = null;
        let selectedText = '';
        let infoItemRecord = [];
        // 存储信息项标记的映射：{ 占位符: { text: 文字, type: 信息项 } }
        let placeholderMap = new Map();

        // ========== 核心功能 ==========
        textArea.addEventListener('mouseup', handleSelection);
        textArea.addEventListener('keyup', handleSelection);
        textArea.addEventListener('selectionchange', handleSelection);
        textArea.addEventListener('input', syncTextSource);

        function handleSelection() {
            const selection = window.getSelection();
            selectedText = selection.toString().trim();

            infoItemBtns.forEach(btn => {
                if (!selectedText) {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                }
            });

            selectedRange = selectedText && selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
        }

        [btnCustomerName, btnContactInfo, btnContractId, btnContractAmount, btnOther].forEach(btn => {
            btn.addEventListener('click', () => {
                if (!selectedRange || !selectedText) return;

                const type = btn.getAttribute('data-type');
                const typeName = btn.textContent;
                // 生成唯一占位符（避免与表格符号冲突）
                const placeholder = `__${type}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}__`;

                // 替换选中文本为带样式的span，并存储占位符映射
                replaceSelectedText(type, selectedText, placeholder);
                // 记录信息项数据
                addInfoItemRecord(selectedText, type, typeName);
                // 存储占位符映射
                placeholderMap.set(placeholder, { text: selectedText, type: type });

                window.getSelection().removeAllRanges();
                infoItemBtns.forEach(b => {
                    b.disabled = true;
                    b.classList.add('disabled');
                });
                syncTextSource();
            });
        });

        // ========== 文本同步 ==========
        function syncTextSource() {
            // 获取原始HTML内容而不是纯文本，保留格式包括换行
            let htmlContent = textArea.innerHTML;

            // 遍历所有信息项span，替换为唯一占位符（避免重复文本替换错误）
            const spans = textArea.querySelectorAll('span.customer_name, span.contact_info, span.contract_id, span.contract_amount, span.other');
            spans.forEach(span => {
                const placeholder = span.getAttribute('data-placeholder');
                if (placeholder) {
                    const spanOuterHtml = span.outerHTML;
                    // 使用正则表达式安全地替换span为占位符，保留换行符和其他格式
                    htmlContent = htmlContent.replace(spanOuterHtml, placeholder);

                    // 后续再将占位符替换回span格式
                    htmlContent = htmlContent.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'),
                        spanOuterHtml);
                }
            });

            // 保持原有HTML结构
            textArea.innerHTML = htmlContent;
        }

        /**
         * 替换选中的文本为带信息项样式的span（新增唯一占位符属性）
         * @param {string} type - 信息项类型
         * @param {string} text - 选中的文本
         * @param {string} placeholder - 唯一占位符
         */
        function replaceSelectedText(type, text, placeholder) {
            const selectedNode = selectedRange.commonAncestorContainer.parentElement;
            if (selectedNode.classList.contains(type) && selectedNode.getAttribute('data-placeholder')) {
                return;
            }

            const span = document.createElement('span');
            span.className = type;
            span.classList.add('px-1', 'rounded-sm', 'mr-1');

            // Add custom styling based on type
            switch(type) {
                case 'customer_name':
                    span.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'contact_info':
                    span.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'contract_id':
                    span.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'contract_amount':
                    span.classList.add('bg-purple-100', 'text-purple-800');
                    break;
                case 'other':
                    span.classList.add('bg-indigo-100', 'text-indigo-800');
                    break;
            }

            span.textContent = text;
            span.setAttribute('data-text', text);
            span.setAttribute('data-placeholder', placeholder); // 存储唯一占位符

            selectedRange.deleteContents();
            selectedRange.insertNode(span);

            const newRange = document.createRange();
            newRange.setStartAfter(span);
            newRange.collapse(true);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(newRange);
        }

        // ========== 其他工具函数 ==========
        function addInfoItemRecord(text, type, typeName) {
            const existingIndex = infoItemRecord.findIndex(item => item.text === text);
            if (existingIndex > -1) {
                infoItemRecord[existingIndex] = { text, type, typeName };
            } else {
                infoItemRecord.push({ text, type, typeName });
            }
            updateInfoItemDataDisplay();
        }

        function removeInfoItemRecord(text) {
            const index = infoItemRecord.findIndex(item => item.text === text);
            if (index > -1) {
                infoItemRecord.splice(index, 1);
                updateInfoItemDataDisplay();
                return true;
            }
            return false;
        }

        function updateInfoItemDataDisplay() {
            infoItemData.textContent = infoItemRecord.length === 0
                ? '暂无信息项数据'
                : infoItemRecord.map((item, index) => `${index + 1}. 文字：${item.text} | 信息项：${item.typeName}（${item.type}）`).join('\n');
        }

        // ========== 取消标定功能 ==========
        function unmarkText(spanElement) {
            const originalText = spanElement.getAttribute('data-text');
            const placeholder = spanElement.getAttribute('data-placeholder');

            // Remove from records
            removeInfoItemRecord(originalText);

            // Remove from placeholder map
            placeholderMap.delete(placeholder);

            // Replace span with original text
            const textNode = document.createTextNode(originalText);
            spanElement.parentNode.replaceChild(textNode, spanElement);
        }

        // Add event listener to text area for clicks on marked text
        textArea.addEventListener('click', function(event) {
            if (event.target.tagName === 'SPAN' &&
                (event.target.classList.contains('customer_name') ||
                 event.target.classList.contains('contact_info') ||
                 event.target.classList.contains('contract_id') ||
                 event.target.classList.contains('contract_amount') ||
                 event.target.classList.contains('other'))) {

                // Prevent text selection when clicking on marked text
                event.preventDefault();

                // Unmark the clicked text
                unmarkText(event.target);
            }
        });

        // ========== 扩展功能 ==========
        resetBtn.addEventListener('click', () => {
            textArea.innerHTML = '';
            infoItemRecord = [];
            placeholderMap.clear(); // 清空占位符映射
            updateInfoItemDataDisplay();
            infoItemBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });
        });

        exportBtn.addEventListener('click', () => {
            if (infoItemRecord.length === 0) {
                alert('暂无信息项数据可导出！');
                return;
            }

            const jsonData = JSON.stringify(infoItemRecord, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `信息项数据_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // 为可编辑区域添加初始提示
        if (textArea.innerHTML.trim() === '') {
            textArea.innerHTML = '';
        }
    </script>
</body>
</html>
