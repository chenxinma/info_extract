# destination spec

## destination
destination模块负责收集提取的数据并将其导出到最终输出格式。

## 架构
destination模块是处理管道（pipeline）的最末端组件，接收来自上游节点（extractors）提供的 `pre_results` 作为输入数据。这些数据包含了所有已提取和处理的信息，destination模块负责将这些数据导出到最终的输出格式。

## 需求

### 需求：Excel 导出
系统应将提取的数据导出到具有预定义列结构的标准化 Excel 文件中。

#### 场景：导出到 Excel
- 当处理管道运行到destination模块时
- 系统从 `pre_results` 中获取所有上游处理结果
- 并按源对文件进行分组
- 并创建具有标准化列标题的 Excel 工作簿
- 并用提取的数据填充工作表
- 并将 Excel 文件保存到目标目录中

#### 场景：处理不同格式的 JSON 数据
- 当 `pre_results` 中的 JSON 数据包含对象数组时
- 系统将数组中的每个对象作为一行数据处理
- 当 `pre_results` 中的 JSON 数据包含单个对象时
- 系统将该对象作为一行数据处理

#### 场景：错误处理
- 当 JSON 数据格式不正确时
- 系统记录错误但继续处理其他数据
- 当工作簿创建失败时
- 系统记录错误并跳过该工作簿的导出

### 需求：列映射
系统应将提取的字段映射到配置中定义的标准化列名。

#### 场景：列映射
- 当提取的数据包含各种名称的字段时
- 系统将这些字段映射到标准化的列名
- 并用空值填充缺失的字段
- 并在映射过程中保持数据完整性

#### 场景：列定义配置
- 当系统启动时
- 从 `config/output.yaml` 文件加载列定义
- 并使用这些定义来构建 Excel 表头

### 需求：数据聚合
系统应将来自多个源的数据聚合成统一的输出文件。

#### 场景：聚合数据
- 当数据来自多个文件或源时
- 系统将相关数据分组在一起
- 并创建合并的输出文件

#### 场景：文件分组
- 当处理 `pre_results` 中的多个 JSON 文件时
- 系统根据文件名前缀对文件进行分组
- 例如：`data_sheet1.json` 和 `data_sheet2.json` 会被归为 `data` 组
- 并为每个组创建单独的工作簿

### 需求：输出格式
系统应生成符合预定义格式的 Excel 文件。

#### 场景：生成标准格式的 Excel
- 当数据处理完成时
- 系统生成 `.xlsx` 格式的文件
- 文件名格式为 `{group_name}_formated.xlsx`
- 第一行为表头，包含预定义的列名
- 后续每行为一条数据记录

### 需求：数据处理
系统应能处理多种数据类型和边缘情况。

#### 场景：处理空值
- 当某个字段没有值时
- 系统在 Excel 单元格中留空

#### 场景：处理不存在的字段
- 当某行数据缺少某些字段时
- 系统在对应列中填入空值

#### 场景：无数据文件
- 当 `pre_results` 中没有找到有效的数据时
- 系统跳过导出并记录警告信息