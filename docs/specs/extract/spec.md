# 信息提取详细设计

## 目的
实现多种数据源的信息提取功能，支持纯文本、电子表格和数据框映射等多种提取方式。

## 需求

### 需求：纯文本信息提取
系统应能从纯文本内容中提取结构化信息。

#### 场景：邮件内容提取
- 当输入为纯文本格式的邮件内容时
- 系统使用语言模型进行信息抽取
- 提取结果包含人员入职、离职等人力资源相关信息

#### 场景：批量处理文本文件
- 当有多个文本文件需要处理时
- 系统支持并行处理以提高效率
- 处理结果保存为JSON格式

### 需求：电子表格信息提取
系统应能从电子表格数据中提取结构化信息。

#### 场景：表头映射到标准字段
- 当输入为电子表格数据时
- 系统使用AI模型分析列与标准字段的映射关系
- 生成SQL脚本实现数据转换

#### 场景：结果缓存
- 当遇到相同的表头结构时
- 系统使用缓存的SQL映射脚本
- 提高处理效率并减少API调用

### 需求：数据框映射提取
系统应能通过语义匹配将数据表头映射到标准字段。

#### 场景：语义表头匹配
- 当输入表格包含与标准字段语义相似的表头时
- 系统使用语义相似度算法进行匹配
- 匹配结果包含置信度分数

#### 场景：字段类型处理
- 当数据包含特定类型的字段时
- 系统对日期和年月字段进行格式标准化
- 日期字段统一为'YYYY-MM-DD'，年月字段统一为'YYYY-MM'

### 需求：工作类型识别
系统应能根据表头和表名识别工作类型（入职/离职）。

#### 场景：自动识别作业类型
- 当数据包含入职日期或离职日期字段时
- 系统根据字段存在情况生成相应的作业类型
- 根据表名关键词（入职、离职、增员、减员）辅助判断

## 技术设计

### 核心组件

#### PlainExtractor
纯文本提取器，基于语言模型进行信息抽取。

**功能：**
- 使用langextract库进行文本信息抽取
- 支持通过OpenAI API的兼容接口进行处理
- 根据预定义的提示词和示例进行信息抽取
- 处理结果保存为JSON格式

#### SpreadsheetExtractor
电子表格提取器，通过AI模型生成SQL映射脚本。

**功能：**
- 读取Parquet格式的电子表格数据
- 使用AI模型分析表头与标准字段的映射关系
- 生成DuckDB兼容的SQL查询脚本
- 实现SQL脚本缓存以提高处理效率
- 处理异常情况并支持规则修正

#### DataFrameMappingExtract
数据框映射提取器，基于语义相似度进行表头标准化。

**功能：**
- 执行异步映射提取过程
- 处理Parquet格式的输入数据
- 使用语义相似度算法进行表头匹配
- 生成标准化的SQL查询
- 对结果进行日期格式化处理
- 验证输入数据格式

#### SemanticHeaderNormalizer
语义表头标准化器，基于语义相似度进行表头匹配。

**功能：**
- 使用预训练的BERT模型进行文本语义表示
- 计算输入表头与标准表头的语义相似度
- 支持同义词匹配（从字段说明中提取同义词）
- 实现贪心分配算法避免冲突匹配
- 提供上下文重评估机制解决重复匹配问题

#### ColumnUtil
表头清洗工具类。

**功能：**
- 提供高级文本清洗功能
- 移除特殊字符、换行符、括号等
- 处理空值和异常情况

### 数据结构

#### ExtractResult
文本提取结果类型，包含：
- document: 文档标识符
- data: 提取的数据列表

#### Normalized
标准化匹配结果的元组类型：(标准字段名, 输入字段名, 相似度分数)

#### NormalizeOutput
标准化输出类型，包含：
- normalized: 标准化结果列表
- unmatched: 未匹配的输入字段列表

### 算法流程

#### 语义相似度匹配流程 (DataFrameMappingExtract)
1. 使用BERT模型计算标准字段和输入字段的语义表示
2. 计算余弦相似度矩阵
3. 为每个标准字段聚合其所有同义词的最大相似度
4. 按置信度排序候选匹配
5. 使用贪心算法分配匹配，避免冲突
6. 补全未匹配的标准字段

#### 上下文重评估流程 (DataFrameMappingExtract)
1. 检查是否有输入字段被多个标准字段匹配
2. 保留置信度最高的匹配，其他置空
3. 重新整理匹配结果，确保每个标准字段最多对应一个输入字段

#### 并行文本处理流程 (PlainExtractor)
1. 加载多个文本文件内容
2. 创建Document对象用于处理
3. 使用langextract库进行并行信息抽取
4. 处理结果并保存为JSON格式

#### SQL映射生成流程 (SpreadsheetExtractor)
1. 读取Parquet格式的数据框
2. 清理列名中的特殊字符
3. 使用AI模型生成SQL映射脚本
4. 执行SQL脚本完成数据转换
5. 对日期和月份字段进行格式化
6. 保存结果为JSON格式
