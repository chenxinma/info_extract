# 源规范

## 目的
源模块负责读取和解析各种文件格式（电子邮件、电子表格），并将它们转换为可由提取模块处理的中间表示。

## 架构
源模块是处理管道（pipeline）的起始组件，负责扫描源目录中的文件，将它们解析为中间格式，并将结果传递给下游的提取模块。源模块处理三种主要类型的文件：EML邮件、MSG邮件和Excel电子表格。

## 需求

### 需求：电子邮件文件处理
系统应处理EML和MSG格式的电子邮件文件，提取邮件正文和附件。

#### 场景：处理EML文件
- 当EML文件被放置在源目录中时
- 系统提取邮件正文内容（HTML或纯文本）
- 并将其保存为处理目录中的文本文件
- 并提取任何Excel附件并保存在子目录中
- 并将处理结果传递给下游模块

#### 场景：处理MSG文件
- 当MSG文件被放置在源目录中时
- 系统提取邮件正文内容（HTML或纯文本）
- 并将其保存为处理目录中的文本文件
- 并提取任何Excel附件并保存在子目录中
- 并将处理结果传递给下游模块

#### 场景：邮件正文处理
- 当提取邮件正文时
- 系统优先提取HTML格式的内容，如果不存在则提取纯文本
- 并将HTML内容转换为Markdown格式
- 并清理邮件正文，移除多余的空白行和空格

#### 场景：附件处理
- 当邮件包含附件时
- 系统识别Excel格式的附件（.xls, .xlsx）
- 并在处理目录中创建与邮件同名的子目录来保存附件
- 并为每个附件生成独立的文件路径

#### 场景：文件名编码
- 当附件文件名使用编码格式时
- 系统自动解码文件名以获得正确的文件名

### 需求：Excel文件处理
系统应处理Excel文件（XLS/XLSX），提取工作表数据并将其转换为Parquet格式。

#### 场景：处理Excel文件
- 当Excel文件被放置在源目录中时
- 系统识别可见工作表（跳过隐藏工作表）
- 并自动检测标题行
- 并将工作表数据转换为Parquet格式
- 并将Parquet文件保存在处理目录中
- 并为每个工作表生成元数据

#### 场景：标题行检测
- 当处理Excel工作表时
- 系统自动扫描前10行以识别标题行
- 并使用包含"姓名"、"身份证"等关键字的行作为标题行
- 并过滤掉空值比例过高的行

#### 场景：数据清理
- 当处理Excel数据时
- 系统删除姓名为空的行
- 并为每行添加颜色信息作为"行颜色"列

#### 场景：元数据生成
- 当处理完Excel文件时
- 系统为每个工作表生成元数据
- 并将所有元数据保存到`excel_meta`文件中

### 需求：文件命名
系统应为处理后的文件生成一致的命名方案。

#### 场景：文本文件命名
- 当保存邮件正文为文本文件时
- 系统使用原始文件名加上时间戳作为新文件名
- 格式为：`{original_filename}_{timestamp}.txt`

#### 场景：Parquet文件命名
- 当保存Excel工作表为Parquet文件时
- 系统使用原始文件名和工作表名作为新文件名
- 格式为：`{excel_filename}_{sheet_name}.parquet`

### 需求：错误处理
系统应优雅地处理文件处理错误。

#### 场景：损坏的文件
- 当在处理过程中遇到损坏的文件时
- 系统将文件移动到错误目录
- 并记录错误详情

#### 场景：处理异常
- 当处理文件时发生异常
- 系统记录详细的错误信息
- 并继续处理其他文件

#### 场景：编码问题
- 当遇到文件编码问题时
- 系统使用错误忽略模式继续处理
- 并尝试多种方法解码内容

### 需求：目录管理
系统应正确管理源目录和处理目录。

#### 场景：目录创建
- 当系统初始化时
- 系统自动创建源目录和处理目录（如果不存在）
- 并在需要时创建错误目录

#### 场景：文件移动
- 当文件处理失败时
- 系统将文件移动到错误目录以避免重复处理