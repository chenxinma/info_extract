# UI详细设计规范

## 目的
设计一个基于FastAPI的Web用户界面，提供图形化操作界面来替代现有的命令行界面，使用户可以通过网页浏览工作目录、选择处理文件、启动处理任务并查看处理结果。

## 需求

### 需求：Web应用框架
系统需要基于FastAPI框架构建，提供稳定的Web服务。

#### 场景：应用初始化
- 当用户首次访问Web应用时
- 系统将初始化FastAPI应用实例
- 应用将加载必要的配置和静态资源
- 应用将准备接收HTTP请求
- 应用将自动在浏览器中打开界面

#### 实现细节：
- 使用FastAPI框架构建Web服务
- 集成CORS中间件以支持跨域请求
- 静态文件通过StaticFiles提供服务
- 应用启动时自动打开浏览器访问UI

### 需求：用户界面
系统需要提供直观的用户界面，支持工作目录浏览和任务管理。

#### 场景：主页显示
- 当用户访问根路径"/"时
- 系统将显示主页，包含以下组件：
  - 工作目录设置输入框
  - 工作目录文件树浏览区域
  - 已选择文件列表
  - "开始处理"按钮
  - 实时日志显示区域

#### 实现细节：
- 主页面采用Bootstrap 5框架设计
- 左侧显示工作目录浏览区域
- 右侧显示任务管理和实时日志
- 响应式设计适配不同屏幕尺寸

#### 场景：配置管理页面
- 当用户访问"/config/info_item_ui"路径时
- 系统将显示信息抽取配置管理页面
- 页面包含配置项列表和编辑功能
- 支持配置项的增删改查和排序功能

#### 实现细节：
- 提供增删改查标准表头配置功能
- 支持数据类型（文本、数字、日期、布尔）设置
- 支持拖拽排序功能
- 提供SQL和AI提示词预览功能
- 支持配置导出/导入功能

#### 场景：任务管理
- 当用户访问根路径"/"时
- 系统将显示任务管理区域，包含：
  - 当前运行任务显示
  - 任务进度条
  - 任务状态显示
  - 任务取消功能
  - 历史任务显示

#### 实现细节：
- 任务状态包括：待处理、处理中、已完成、已失败、已取消
- 实时进度更新通过Streaming Response实现
- 任务取消功能允许用户中断正在运行的任务

### 需求：工作目录浏览功能
系统需要提供本地工作目录的文件树浏览功能。

#### 场景：工作目录浏览
- 当用户设置工作目录后
- 系统将显示该目录下的所有子目录和文件
- 系统将支持目录树展开/折叠操作
- 系统将支持文件选择操作
- 系统将显示文件类型图标和基本信息

#### 实现细节：
- 提供API接口返回目录内容列表
- 限制文件类型显示为支持的类型（.eml, .msg, .xlsx, .xls, .csv, .txt, .pdf, .docx, .doc, .json）
- 实现路径安全验证，防止目录遍历攻击

#### 场景：文件选择
- 当用户在文件树中选择文件时
- 系统将验证文件类型（.eml, .msg, .xlsx, .xls, .csv等）
- 系统将将选定的文件添加到处理列表
- 系统将在UI上高亮显示已选择的文件

#### 实现细节：
- 支持多文件选择
- 通过点击文件名实现选择/取消选择
- 选中的文件在UI中高亮显示

### 需求：任务管理
系统需要提供任务创建、监控和管理功能。

#### 场景：任务创建
- 当用户点击"开始处理"按钮时
- 系统将基于当前设置和选择的文件创建处理任务
- 系统将分配唯一任务ID
- 系统将启动后台处理进程
- 系统将更新任务状态为"处理中"

#### 实现细节：
- 使用UUID生成唯一任务ID
- 任务状态包括：pending, processing, completed, failed, cancelled
- 任务信息在内存中管理（未持久化到数据库）

#### 场景：任务状态监控
- 当用户启动任务时
- 系统将通过Streaming Response方式建立流式连接
- 系统将通过流式响应持续推送处理进度百分比
- 系统将通过流式响应持续推送实时处理日志
- 系统将通过流式响应更新任务状态（处理中、已完成、失败）
- 客户端将实时接收并更新UI显示

#### 实现细节：
- 使用StreamingResponse实现服务器发送事件
- 流式消息格式为JSON，包含type和data字段
- 消息类型包括：task_info, status_update, progress_update, completion, error
- 客户端JavaScript解析流式响应并更新UI

#### 场景：任务取消
- 当用户请求取消任务时
- 系统将更新任务状态为"已取消"
- 系统将立即停止当前任务的执行
- 系统将记录任务完成时间
- 相关资源应被释放

#### 实现细节：
- 通过API接口实现任务取消
- 使用`threading.Event`作为中断令牌
- 在管道执行的关键点检查中断事件
- 收到取消请求时设置中断事件
- 更新任务状态为cancelled并更新完成时间
- 真正中断正在运行的处理进程

### 需求：与现有处理流程集成
系统需要保持与CLI模式相同的处理能力。

#### 场景：处理流程集成
- 当启动Web界面处理任务时
- 系统将调用现有的Pipeline、Extractor、Source和Destination组件
- 系统将使用与CLI模式相同的处理逻辑
- 系统将确保输出结果的一致性

#### 实现细节：
- 通过Executor类集成现有处理流程
- 使用相同的Pipeline和处理逻辑
- 处理结果保存到相同的destination目录

### 需求：结果管理
系统需要妥善管理处理结果文件。

#### 场景：结果文件生成
- 当处理任务完成时
- 系统将在destination目录生成结果文件
- 系统将记录任务完成状态和元数据
- 系统将在任务管理页面显示完成状态

#### 实现细节：
- 结果文件路径保存在任务对象中
- 任务完成后自动更新UI显示结果文件

#### 场景：结果文件访问
- 当用户访问结果文件时
- 系统将验证用户权限
- 系统将提供安全的文件访问
- 系统将记录访问日志

#### 实现细节：
- 通过API接口提供结果文件访问
- 实现路径安全验证防止路径遍历

### 需求：错误处理
系统需要提供完善的错误处理和用户反馈。

#### 场景：目录浏览错误处理
- 当工作目录访问失败时
- 系统将显示具体的错误信息
- 系统将记录错误日志

#### 实现细节：
- API返回错误信息给前端
- 前端显示错误消息

#### 场景：处理错误处理
- 当处理任务失败时
- 系统将显示错误信息和失败原因
- 系统将保存处理日志供用户查看

#### 实现细节：
- 通过流式响应发送错误信息
- 更新任务状态为failed并记录错误详情

### 需求：安全和性能
系统需要确保基本的安全性和良好的性能。

#### 场景：目录安全
- 当访问工作目录时
- 系统将确保路径安全，防止路径遍历攻击
- 系统将限制访问范围到指定工作目录及其子目录

#### 实现细节：
- 使用Path.resolve()和is_relative_to()方法验证路径安全性
- 检查请求路径是否在工作目录范围内

#### 场景：配置数据安全
- 当配置数据被访问时
- 系统将通过认证API提供安全访问
- 系统将对敏感操作进行验证

#### 实现细节：
- 提供RESTful API对配置数据进行增删改查
- 验证输入参数的安全性

## 实现架构

### 前端技术栈
- HTML5 + CSS3 + JavaScript
- Bootstrap 5 框架
- Font Awesome 图标库
- 原生JavaScript实现流式数据处理

### 后端技术栈
- FastAPI 框架
- StreamingResponse 实现服务器发送事件
- 内存存储任务状态（未使用数据库持久化）

### 数据流
1. 用户在UI中选择文件和设置工作目录
2. 前端通过API请求与后端交互
3. 后端启动处理任务并通过流式响应返回进度
4. 前端实时更新UI显示进度和日志
5. 任务完成后更新结果区域